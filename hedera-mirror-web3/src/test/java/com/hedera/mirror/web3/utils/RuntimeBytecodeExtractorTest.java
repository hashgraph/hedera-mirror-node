/*
 * Copyright (C) 2024 Hedera Hashgraph, LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.hedera.mirror.web3.utils;

import static org.assertj.core.api.AssertionsForClassTypes.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;

import org.junit.jupiter.api.Test;

class RuntimeBytecodeExtractorTest {

    private static final String INIT_BYTECODE_V1 =
            "608060405234801561000f575f80fd5b50610e708061001d5f395ff3fe608060405234801561000f575f80fd5b50600436106100f0575f3560e01c80637127afff11610093578063e266dac311610063578063e266dac3146101ba578063ece056bd146101d2578063ee82ac5e146101da578063f041d2d9146101ec575f80fd5b80637127afff1461017a57806381ea440814610182578063943c04ed146101945780639a8a0592146101b4575f80fd5b80632c159a1a116100ce5780632c159a1a1461013357806333b43abb146101485780633dd9ebdf1461015057806342bcad2814610173575f80fd5b8063016a3738146100f457806316131e0f1461010957806318969da21461011e575b5f80fd5b610107610102366004610c8f565b6101f4565b005b445b6040519081526020015b60405180910390f35b610126610200565b6040516101159190610caa565b61013b610341565b6040516101159190610cfc565b61013b610410565b610158610478565b60408051825181526020928301519281019290925201610115565b434061010b565b61015861053a565b61010b610190366004610c8f565b3f90565b61019c6105c2565b6040516001600160a01b039091168152602001610115565b4661010b565b6101c2610698565b6040519015158152602001610115565b61013b6109d3565b61010b6101e8366004610d2e565b4090565b61010b610a28565b806001600160a01b0316ff5b610208610bdb565b600c610212610bdb565b7f48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa581527fd182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b6020820152610263610bf9565b6261626360e81b81525f60208201819052604082018190526060820152610288610bdb565b600360f81b8082525f60208084018290528551868201518651878401516040808a015160608b0151915160e08e901b6001600160e01b03191697810197909752602487019590955260448601939093526064850191909152608484015260a483019190915260c482015260e481019290925260ec8201819052600160f81b60f483015260019160f501604051602081830303815290604052905060408760d56020840160095f19fa610338575f80fd5b50505050505090565b60605f604051602001610374906020808252600c908201526b12195b1b1bcb0815dbdc9b1960a21b604082015260600190565b60405160208183030381529060405290505f8060046001600160a01b0316836040516020016103a39190610cfc565b60408051601f19818403018152908290526103bd91610d59565b5f604051808303815f865af19150503d805f81146103f6576040519150601f19603f3d011682016040523d82523d5f602084013e6103fb565b606091505b509150915081610409575f80fd5b9392505050565b60605f6040516020016104499060208082526012908201527148656c6c6f2c20524950454d442d3136302160701b604082015260600190565b60405160208183030381529060405290505f8060036001600160a01b0316836040516020016103a39190610cfc565b604080518082019091525f80825260208201525f6104b76040805180820182525f80825260209182015281518083019092526001825260029082015290565b90505f6104e56040805180820182525f80825260209182015281518083019092526001825260029082015290565b90506104ef610bf9565b8251815260208084015181830152825160408301528201516060808301919091525f908560c0848460066107d05a03f19050808061052957fe5b5080610533575f80fd5b5050505090565b604080518082019091525f80825260208201525f6105796040805180820182525f80825260209182015281518083019092526001825260029082015290565b9050610583610c17565b8151815260208083015190820152600360408201525f6060846080848460076107d05a03f1905080806105b257fe5b50806105bc575f80fd5b50505090565b604051630d0c2e6d60e31b60248201819052600160448301819052603960f91b60648401819052607360f81b608485018190525f9485908190859060a40160408051601f198184030181529181526020820180516001600160e01b0316634b6883fb60e11b179052516106359190610d59565b5f604051808303815f865af19150503d805f811461066e576040519150601f19603f3d011682016040523d82523d5f602084013e610673565b606091505b509150915081610681575f80fd5b61068a81610d74565b60601c965050505050505090565b604080516080810182525f818301819052606082018190528251808401909352600183526002602084015291829190819081526020016107016106fc6040805180820182525f80825260209182015281518083019092526001825260029082015290565b610a7f565b81525090505f604051806040016040528061071a610b1b565b8152602001610727610b1b565b9052905060025f610739826006610dc4565b90505f8167ffffffffffffffff81111561075557610755610de1565b60405190808252806020026020018201604052801561077e578160200160208202803683370190505b5090505f5b838110156109935785816002811061079d5761079d610d45565b602002015151826107af836006610dc4565b6107b9905f610df5565b815181106107c9576107c9610d45565b6020026020010181815250508581600281106107e7576107e7610d45565b602002015160200151828260066107fe9190610dc4565b610809906001610df5565b8151811061081957610819610d45565b60200260200101818152505084816002811061083757610837610d45565b602002015151518261084a836006610dc4565b610855906002610df5565b8151811061086557610865610d45565b60200260200101818152505084816002811061088357610883610d45565b602002015151600160200201518261089c836006610dc4565b6108a7906003610df5565b815181106108b7576108b7610d45565b6020026020010181815250508481600281106108d5576108d5610d45565b6020020151602001515f600281106108ef576108ef610d45565b602002015182610900836006610dc4565b61090b906004610df5565b8151811061091b5761091b610d45565b60200260200101818152505084816002811061093957610939610d45565b60200201516020015160016002811061095457610954610d45565b602002015182610965836006610dc4565b610970906005610df5565b8151811061098057610980610d45565b6020908102919091010152600101610783565b5061099c610c35565b5f60208260208602602086015f60086107d05a03f1905080806109bb57fe5b50806109c5575f80fd5b505115159695505050505050565b60605f6040516020016109f9906c48656c6c6f2c20776f726c642160981b8152600d0190565b60405160208183030381529060405290505f8060026001600160a01b0316836040516020016103a39190610cfc565b5f80600590505f600390505f600b905060405160208152602080820152602060408201528360608201528260808201528160a082015260c05160208160c0845f60055f19f1610a75575f80fd5b5195945050505050565b604080518082019091525f808252602082015281517f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd4790158015610ac557506020830151155b15610ae4575050604080518082019091525f8082526020820152919050565b6040518060400160405280845f01518152602001828560200151610b089190610e08565b610b129084610e27565b90529392505050565b610b23610c53565b50604080516080810182527f198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c28183019081527f1800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed6060830152815281518083019092527f090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b82527f12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa60208381019190915281019190915290565b60405180604001604052806002906020820280368337509192915050565b60405180608001604052806004906020820280368337509192915050565b60405180606001604052806003906020820280368337509192915050565b60405180602001604052806001906020820280368337509192915050565b6040518060400160405280610c66610bdb565b8152602001610c73610bdb565b905290565b6001600160a01b0381168114610c8c575f80fd5b50565b5f60208284031215610c9f575f80fd5b813561040981610c78565b6040810181835f5b6002811015610cd1578151835260209283019290910190600101610cb2565b50505092915050565b5f5b83811015610cf4578181015183820152602001610cdc565b50505f910152565b602081525f8251806020840152610d1a816040850160208701610cda565b601f01601f19169190910160400192915050565b5f60208284031215610d3e575f80fd5b5035919050565b634e487b7160e01b5f52603260045260245ffd5b5f8251610d6a818460208701610cda565b9190910192915050565b805160208201516bffffffffffffffffffffffff198082169291906014831015610da85780818460140360031b1b83161693505b505050919050565b634e487b7160e01b5f52601160045260245ffd5b8082028115828204841417610ddb57610ddb610db0565b92915050565b634e487b7160e01b5f52604160045260245ffd5b80820180821115610ddb57610ddb610db0565b5f82610e2257634e487b7160e01b5f52601260045260245ffd5b500690565b81810381811115610ddb57610ddb610db056fea264697066735822122021521b5af2ad54f11bbe64fb7a6570aef64fddb43bfc2016196a77918690d27c64736f6c63430008180033";
    private static final String EXPECTED_RUNTIME_BYTECODE_V1 =
            "0x608060405234801561000f575f80fd5b50600436106100f0575f3560e01c80637127afff11610093578063e266dac311610063578063e266dac3146101ba578063ece056bd146101d2578063ee82ac5e146101da578063f041d2d9146101ec575f80fd5b80637127afff1461017a57806381ea440814610182578063943c04ed146101945780639a8a0592146101b4575f80fd5b80632c159a1a116100ce5780632c159a1a1461013357806333b43abb146101485780633dd9ebdf1461015057806342bcad2814610173575f80fd5b8063016a3738146100f457806316131e0f1461010957806318969da21461011e575b5f80fd5b610107610102366004610c8f565b6101f4565b005b445b6040519081526020015b60405180910390f35b610126610200565b6040516101159190610caa565b61013b610341565b6040516101159190610cfc565b61013b610410565b610158610478565b60408051825181526020928301519281019290925201610115565b434061010b565b61015861053a565b61010b610190366004610c8f565b3f90565b61019c6105c2565b6040516001600160a01b039091168152602001610115565b4661010b565b6101c2610698565b6040519015158152602001610115565b61013b6109d3565b61010b6101e8366004610d2e565b4090565b61010b610a28565b806001600160a01b0316ff5b610208610bdb565b600c610212610bdb565b7f48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa581527fd182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b6020820152610263610bf9565b6261626360e81b81525f60208201819052604082018190526060820152610288610bdb565b600360f81b8082525f60208084018290528551868201518651878401516040808a015160608b0151915160e08e901b6001600160e01b03191697810197909752602487019590955260448601939093526064850191909152608484015260a483019190915260c482015260e481019290925260ec8201819052600160f81b60f483015260019160f501604051602081830303815290604052905060408760d56020840160095f19fa610338575f80fd5b50505050505090565b60605f604051602001610374906020808252600c908201526b12195b1b1bcb0815dbdc9b1960a21b604082015260600190565b60405160208183030381529060405290505f8060046001600160a01b0316836040516020016103a39190610cfc565b60408051601f19818403018152908290526103bd91610d59565b5f604051808303815f865af19150503d805f81146103f6576040519150601f19603f3d011682016040523d82523d5f602084013e6103fb565b606091505b509150915081610409575f80fd5b9392505050565b60605f6040516020016104499060208082526012908201527148656c6c6f2c20524950454d442d3136302160701b604082015260600190565b60405160208183030381529060405290505f8060036001600160a01b0316836040516020016103a39190610cfc565b604080518082019091525f80825260208201525f6104b76040805180820182525f80825260209182015281518083019092526001825260029082015290565b90505f6104e56040805180820182525f80825260209182015281518083019092526001825260029082015290565b90506104ef610bf9565b8251815260208084015181830152825160408301528201516060808301919091525f908560c0848460066107d05a03f19050808061052957fe5b5080610533575f80fd5b5050505090565b604080518082019091525f80825260208201525f6105796040805180820182525f80825260209182015281518083019092526001825260029082015290565b9050610583610c17565b8151815260208083015190820152600360408201525f6060846080848460076107d05a03f1905080806105b257fe5b50806105bc575f80fd5b50505090565b604051630d0c2e6d60e31b60248201819052600160448301819052603960f91b60648401819052607360f81b608485018190525f9485908190859060a40160408051601f198184030181529181526020820180516001600160e01b0316634b6883fb60e11b179052516106359190610d59565b5f604051808303815f865af19150503d805f811461066e576040519150601f19603f3d011682016040523d82523d5f602084013e610673565b606091505b509150915081610681575f80fd5b61068a81610d74565b60601c965050505050505090565b604080516080810182525f818301819052606082018190528251808401909352600183526002602084015291829190819081526020016107016106fc6040805180820182525f80825260209182015281518083019092526001825260029082015290565b610a7f565b81525090505f604051806040016040528061071a610b1b565b8152602001610727610b1b565b9052905060025f610739826006610dc4565b90505f8167ffffffffffffffff81111561075557610755610de1565b60405190808252806020026020018201604052801561077e578160200160208202803683370190505b5090505f5b838110156109935785816002811061079d5761079d610d45565b602002015151826107af836006610dc4565b6107b9905f610df5565b815181106107c9576107c9610d45565b6020026020010181815250508581600281106107e7576107e7610d45565b602002015160200151828260066107fe9190610dc4565b610809906001610df5565b8151811061081957610819610d45565b60200260200101818152505084816002811061083757610837610d45565b602002015151518261084a836006610dc4565b610855906002610df5565b8151811061086557610865610d45565b60200260200101818152505084816002811061088357610883610d45565b602002015151600160200201518261089c836006610dc4565b6108a7906003610df5565b815181106108b7576108b7610d45565b6020026020010181815250508481600281106108d5576108d5610d45565b6020020151602001515f600281106108ef576108ef610d45565b602002015182610900836006610dc4565b61090b906004610df5565b8151811061091b5761091b610d45565b60200260200101818152505084816002811061093957610939610d45565b60200201516020015160016002811061095457610954610d45565b602002015182610965836006610dc4565b610970906005610df5565b8151811061098057610980610d45565b6020908102919091010152600101610783565b5061099c610c35565b5f60208260208602602086015f60086107d05a03f1905080806109bb57fe5b50806109c5575f80fd5b505115159695505050505050565b60605f6040516020016109f9906c48656c6c6f2c20776f726c642160981b8152600d0190565b60405160208183030381529060405290505f8060026001600160a01b0316836040516020016103a39190610cfc565b5f80600590505f600390505f600b905060405160208152602080820152602060408201528360608201528260808201528160a082015260c05160208160c0845f60055f19f1610a75575f80fd5b5195945050505050565b604080518082019091525f808252602082015281517f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd4790158015610ac557506020830151155b15610ae4575050604080518082019091525f8082526020820152919050565b6040518060400160405280845f01518152602001828560200151610b089190610e08565b610b129084610e27565b90529392505050565b610b23610c53565b50604080516080810182527f198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c28183019081527f1800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed6060830152815281518083019092527f090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b82527f12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa60208381019190915281019190915290565b60405180604001604052806002906020820280368337509192915050565b60405180608001604052806004906020820280368337509192915050565b60405180606001604052806003906020820280368337509192915050565b60405180602001604052806001906020820280368337509192915050565b6040518060400160405280610c66610bdb565b8152602001610c73610bdb565b905290565b6001600160a01b0381168114610c8c575f80fd5b50565b5f60208284031215610c9f575f80fd5b813561040981610c78565b6040810181835f5b6002811015610cd1578151835260209283019290910190600101610cb2565b50505092915050565b5f5b83811015610cf4578181015183820152602001610cdc565b50505f910152565b602081525f8251806020840152610d1a816040850160208701610cda565b601f01601f19169190910160400192915050565b5f60208284031215610d3e575f80fd5b5035919050565b634e487b7160e01b5f52603260045260245ffd5b5f8251610d6a818460208701610cda565b9190910192915050565b805160208201516bffffffffffffffffffffffff198082169291906014831015610da85780818460140360031b1b83161693505b505050919050565b634e487b7160e01b5f52601160045260245ffd5b8082028115828204841417610ddb57610ddb610db0565b92915050565b634e487b7160e01b5f52604160045260245ffd5b80820180821115610ddb57610ddb610db0565b5f82610e2257634e487b7160e01b5f52601260045260245ffd5b500690565b81810381811115610ddb57610ddb610db056fea264697066735822122021521b5af2ad54f11bbe64fb7a6570aef64fddb43bfc2016196a77918690d27c64736f6c63430008180033";

    private static final String INIT_BYTECODE_V2 =
            "6104d25f90815560a060405260809081526001906200001f9082620000d1565b503480156200002c575f80fd5b506200019d565b634e487b7160e01b5f52604160045260245ffd5b600181811c908216806200005c57607f821691505b6020821081036200007b57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f821115620000cc57805f5260205f20601f840160051c81016020851015620000a85750805b601f840160051c820191505b81811015620000c9575f8155600101620000b4565b50505b505050565b81516001600160401b03811115620000ed57620000ed62000033565b6200010581620000fe845462000047565b8462000081565b602080601f8311600181146200013b575f8415620001235750858301515b5f19600386901b1c1916600185901b17855562000195565b5f85815260208120601f198616915b828110156200016b578886015182559484019460019091019084016200014a565b50858210156200018957878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b61185f80620001ab5f395ff3fe60806040526004361062000103575f3560e01c806381a73ad51162000092578063a26388bb116200005e578063a26388bb14620002dd578063ab5b958914620002f4578063c32723ed146200030b578063dbb6f04a146200032f575f80fd5b806381a73ad5146200025357806393423e9c14620002775780639ac27b6214620002a25780639b23d3d914620002b9575f80fd5b80636f0fccab11620000d25780636f0fccab14620001d35780637c93c87e14620001f75780638070450f146200021d57806380b9f03c146200023c575f80fd5b806315dacbea146200010757806350e58786146200014357806351fecdca146200017b578063618dc65e146200019f575b5f80fd5b34801562000113575f80fd5b506200012b6200012536600462000b9b565b6200035f565b60405160079190910b81526020015b60405180910390f35b3480156200014f575f80fd5b506040805180820190915260048152631d195cdd60e21b60208201525b6040516200013a919062000c41565b34801562000187575f80fd5b506200016c6200019936600462000d28565b62000456565b348015620001ab575f80fd5b50620001c3620001bd36600462000d7d565b620004d3565b6040516200013a92919062000de4565b348015620001df575f80fd5b506200016c620001f136600462000e06565b620005f4565b34801562000203575f80fd5b506200021b6200021536600462000e06565b62000661565b005b34801562000229575f80fd5b5060045b6040519081526020016200013a565b6200021b6200024d36600462000e06565b62000751565b3480156200025f575f80fd5b506200016c6200027136600462000e06565b62000788565b34801562000283575f80fd5b506200022d6200029536600462000e06565b6001600160a01b03163190565b6200016c620002b336600462000e24565b620007c6565b348015620002c5575f80fd5b506200012b620002d736600462000b9b565b6200086f565b348015620002e9575f80fd5b506200021b620008b4565b34801562000300575f80fd5b506200016c620008f5565b34801562000317575f80fd5b506200016c6200032936600462000e24565b62000989565b3480156200033b575f80fd5b506200034662000b3c565b6040516001600160a01b0390911681526020016200013a565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290525f908190819061016790630aed65f560e11b9060a4015b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b0319909416939093179092529051620003df919062000e5a565b5f604051808303815f865af19150503d805f81146200041a576040519150601f19603f3d011682016040523d82523d5f602084013e6200041f565b606091505b5091509150816200043257601562000448565b8080602001905181019062000448919062000e77565b60030b979650505050505050565b604051631da187d560e11b81526060906001600160a01b03831690633b430faa906200048790869060040162000c41565b5f604051808303815f875af1158015620004a3573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052620004cc919081019062000e99565b9392505050565b5f60605f806101676001600160a01b031663618dc65e60e01b87876040516024016200050192919062000f14565b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b031990941693909317909252905162000541919062000e5a565b5f604051808303815f865af19150503d805f81146200057c576040519150601f19603f3d011682016040523d82523d5f602084013e62000581565b606091505b50915091507f4af4780e06fe8cb9df64b0794fa6f01399af979175bb988e35e0e57e594567bc8282604051620005b992919062000f39565b60405180910390a181620005de57601560405180602001604052805f815250620005e2565b6016815b60039190910b97909650945050505050565b6060816001600160a01b03166306fdde036040518163ffffffff1660e01b81526004015f60405180830381865afa15801562000632573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526200065b919081019062000e99565b92915050565b604080516001600160a01b03831660248201523360448083019190915282518083039091018152606490910182526020810180516001600160e01b03166316e3e16160e21b17905290515f91829161016791620006be9162000e5a565b5f604051808303815f865af19150503d805f8114620006f9576040519150601f19603f3d011682016040523d82523d5f602084013e620006fe565b606091505b5091509150816200074c5760405162461bcd60e51b8152602060048201526013602482015272119c99595e99481d1bdad95b8819985a5b1959606a1b60448201526064015b60405180910390fd5b505050565b6040516001600160a01b038216903480156108fc02915f818181858888f1935050505015801562000784573d5f803e3d5ffd5b5050565b6060816001600160a01b03166395d89b416040518163ffffffff1660e01b81526004015f60405180830381865afa15801562000632573d5f803e3d5ffd5b60606001620007d6838262000fde565b5060018054620007e69062000f55565b80601f0160208091040260200160405190810160405280929190818152602001828054620008149062000f55565b8015620008635780601f10620008395761010080835404028352916020019162000863565b820191905f5260205f20905b8154815290600101906020018083116200084557829003601f168201915b50505050509050919050565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290525f908190819061016790639b23d3d960e01b9060a4016200039f565b60405162461bcd60e51b8152602060048201526015602482015274437573746f6d20726576657274206d65737361676560581b604482015260640162000743565b60018054620009049062000f55565b80601f0160208091040260200160405190810160405280929190818152602001828054620009329062000f55565b8015620009815780601f10620009575761010080835404028352916020019162000981565b820191905f5260205f20905b8154815290600101906020018083116200096357829003601f168201915b505050505081565b60605f6040516200099a9062000b75565b604051809103905ff080158015620009b4573d5f803e3d5ffd5b5090505f816001600160a01b0316633b430faa856040518263ffffffff1660e01b8152600401620009e6919062000c41565b5f604051808303815f875af115801562000a02573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f1916820160405262000a2b919081019062000e99565b604051630493789b60e31b81529091506001600160a01b0383169063249bc4d89062000a5c90849060040162000c41565b5f604051808303815f875af115801562000a78573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f1916820160405262000aa1919081019062000e99565b506001805462000ab19062000f55565b80601f016020809104026020016040519081016040528092919081815260200182805462000adf9062000f55565b801562000b2e5780601f1062000b045761010080835404028352916020019162000b2e565b820191905f5260205f20905b81548152906001019060200180831162000b1057829003601f168201915b505050505092505050919050565b5f805f545f1b60405162000b509062000b75565b8190604051809103905ff590508015801562000b6e573d5f803e3d5ffd5b5092915050565b61077e80620010ac83390190565b6001600160a01b038116811462000b98575f80fd5b50565b5f805f806080858703121562000baf575f80fd5b843562000bbc8162000b83565b9350602085013562000bce8162000b83565b9250604085013562000be08162000b83565b9396929550929360600135925050565b5f5b8381101562000c0c57818101518382015260200162000bf2565b50505f910152565b5f815180845262000c2d81602086016020860162000bf0565b601f01601f19169290920160200192915050565b602081525f620004cc602083018462000c14565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171562000c955762000c9562000c55565b604052919050565b5f67ffffffffffffffff82111562000cb95762000cb962000c55565b50601f01601f191660200190565b5f62000cdd62000cd78462000c9d565b62000c69565b905082815283838301111562000cf1575f80fd5b828260208301375f602084830101529392505050565b5f82601f83011262000d17575f80fd5b620004cc8383356020850162000cc7565b5f806040838503121562000d3a575f80fd5b823567ffffffffffffffff81111562000d51575f80fd5b62000d5f8582860162000d07565b925050602083013562000d728162000b83565b809150509250929050565b5f806040838503121562000d8f575f80fd5b823562000d9c8162000b83565b9150602083013567ffffffffffffffff81111562000db8575f80fd5b8301601f8101851362000dc9575f80fd5b62000dda8582356020840162000cc7565b9150509250929050565b828152604060208201525f62000dfe604083018462000c14565b949350505050565b5f6020828403121562000e17575f80fd5b8135620004cc8162000b83565b5f6020828403121562000e35575f80fd5b813567ffffffffffffffff81111562000e4c575f80fd5b62000dfe8482850162000d07565b5f825162000e6d81846020870162000bf0565b9190910192915050565b5f6020828403121562000e88575f80fd5b81518060030b8114620004cc575f80fd5b5f6020828403121562000eaa575f80fd5b815167ffffffffffffffff81111562000ec1575f80fd5b8201601f8101841362000ed2575f80fd5b805162000ee362000cd78262000c9d565b81815285602083850101111562000ef8575f80fd5b62000f0b82602083016020860162000bf0565b95945050505050565b6001600160a01b03831681526040602082018190525f9062000dfe9083018462000c14565b8215158152604060208201525f62000dfe604083018462000c14565b600181811c9082168062000f6a57607f821691505b60208210810362000f8957634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200074c57805f5260205f20601f840160051c8101602085101562000fb65750805b601f840160051c820191505b8181101562000fd7575f815560010162000fc2565b5050505050565b815167ffffffffffffffff81111562000ffb5762000ffb62000c55565b62001013816200100c845462000f55565b8462000f8f565b602080601f83116001811462001049575f8415620010315750858301515b5f19600386901b1c1916600185901b178555620010a3565b5f85815260208120601f198616915b82811015620010795788860151825594840194600190910190840162001058565b50858210156200109757878501515f19600388901b60f8161c191681555b505060018460011b0185555b50505050505056fe60a06040525f608081815261001490826100be565b50348015610020575f80fd5b5061017d565b634e487b7160e01b5f52604160045260245ffd5b600181811c9082168061004e57607f821691505b60208210810361006c57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156100b957805f5260205f20601f840160051c810160208510156100975750805b601f840160051c820191505b818110156100b6575f81556001016100a3565b50505b505050565b81516001600160401b038111156100d7576100d7610026565b6100eb816100e5845461003a565b84610072565b602080601f83116001811461011e575f84156101075750858301515b5f19600386901b1c1916600185901b178555610175565b5f85815260208120601f198616915b8281101561014c5788860151825594840194600190910190840161012d565b508582101561016957878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b6105f48061018a5f395ff3fe608060405234801561000f575f80fd5b506004361061003f575f3560e01c8063249bc4d8146100435780633b430faa1461006c578063c19d93fb1461007f575b5f80fd5b6100566100513660046102b0565b610087565b604051610063919061034c565b60405180910390f35b61005661007a3660046102b0565b61011c565b6100566101b9565b60405160609033908190639ac27b62906100a79086905f906020016103b6565b6040516020818303038152906040526040518263ffffffff1660e01b81526004016100d2919061034c565b5f604051808303815f875af11580156100ed573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526101149190810190610440565b509192915050565b60605f61012983826104fe565b505f80546101369061037e565b80601f01602080910402602001604051908101604052809291908181526020018280546101629061037e565b80156101ad5780601f10610184576101008083540402835291602001916101ad565b820191905f5260205f20905b81548152906001019060200180831161019057829003601f168201915b50505050509050919050565b5f80546101c59061037e565b80601f01602080910402602001604051908101604052809291908181526020018280546101f19061037e565b801561023c5780601f106102135761010080835404028352916020019161023c565b820191905f5260205f20905b81548152906001019060200180831161021f57829003601f168201915b505050505081565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561028157610281610244565b604052919050565b5f67ffffffffffffffff8211156102a2576102a2610244565b50601f01601f191660200190565b5f602082840312156102c0575f80fd5b813567ffffffffffffffff8111156102d6575f80fd5b8201601f810184136102e6575f80fd5b80356102f96102f482610289565b610258565b81815285602083850101111561030d575f80fd5b816020840160208301375f91810160200191909152949350505050565b5f5b8381101561034457818101518382015260200161032c565b50505f910152565b602081525f825180602084015261036a81604085016020870161032a565b601f01601f19169190910160400192915050565b600181811c9082168061039257607f821691505b6020821081036103b057634e487b7160e01b5f52602260045260245ffd5b50919050565b5f835160206103c982856020890161032a565b81840191505f85546103da8161037e565b600182811680156103f2576001811461040757610431565b60ff1984168752821515830287019450610431565b895f5260205f205f5b8481101561042957815489820152908301908701610410565b505082870194505b50929998505050505050505050565b5f60208284031215610450575f80fd5b815167ffffffffffffffff811115610466575f80fd5b8201601f81018413610476575f80fd5b80516104846102f482610289565b818152856020838501011115610498575f80fd5b6104a982602083016020860161032a565b95945050505050565b601f8211156104f957805f5260205f20601f840160051c810160208510156104d75750805b601f840160051c820191505b818110156104f6575f81556001016104e3565b50505b505050565b815167ffffffffffffffff81111561051857610518610244565b61052c81610526845461037e565b846104b2565b602080601f83116001811461055f575f84156105485750858301515b5f19600386901b1c1916600185901b1785556105b6565b5f85815260208120601f198616915b8281101561058d5788860151825594840194600190910190840161056e565b50858210156105aa57878501515f19600388901b60f8161c191681555b505060018460011b0185555b50505050505056fea2646970667358221220f9d4ec29ea6039c4ca833a4f380cc942538bdf4f493376c24d4853357941676664736f6c63430008180033a2646970667358221220992b617f20432b99cb9340eed5a817a1ba6bd3d2256265ae4753da69bc2f6da464736f6c63430008180033";
    private static final String EXPECTED_RUNTIME_BYTECODE_V2 =
            "0x60806040526004361062000103575f3560e01c806381a73ad51162000092578063a26388bb116200005e578063a26388bb14620002dd578063ab5b958914620002f4578063c32723ed146200030b578063dbb6f04a146200032f575f80fd5b806381a73ad5146200025357806393423e9c14620002775780639ac27b6214620002a25780639b23d3d914620002b9575f80fd5b80636f0fccab11620000d25780636f0fccab14620001d35780637c93c87e14620001f75780638070450f146200021d57806380b9f03c146200023c575f80fd5b806315dacbea146200010757806350e58786146200014357806351fecdca146200017b578063618dc65e146200019f575b5f80fd5b34801562000113575f80fd5b506200012b6200012536600462000b9b565b6200035f565b60405160079190910b81526020015b60405180910390f35b3480156200014f575f80fd5b506040805180820190915260048152631d195cdd60e21b60208201525b6040516200013a919062000c41565b34801562000187575f80fd5b506200016c6200019936600462000d28565b62000456565b348015620001ab575f80fd5b50620001c3620001bd36600462000d7d565b620004d3565b6040516200013a92919062000de4565b348015620001df575f80fd5b506200016c620001f136600462000e06565b620005f4565b34801562000203575f80fd5b506200021b6200021536600462000e06565b62000661565b005b34801562000229575f80fd5b5060045b6040519081526020016200013a565b6200021b6200024d36600462000e06565b62000751565b3480156200025f575f80fd5b506200016c6200027136600462000e06565b62000788565b34801562000283575f80fd5b506200022d6200029536600462000e06565b6001600160a01b03163190565b6200016c620002b336600462000e24565b620007c6565b348015620002c5575f80fd5b506200012b620002d736600462000b9b565b6200086f565b348015620002e9575f80fd5b506200021b620008b4565b34801562000300575f80fd5b506200016c620008f5565b34801562000317575f80fd5b506200016c6200032936600462000e24565b62000989565b3480156200033b575f80fd5b506200034662000b3c565b6040516001600160a01b0390911681526020016200013a565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290525f908190819061016790630aed65f560e11b9060a4015b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b0319909416939093179092529051620003df919062000e5a565b5f604051808303815f865af19150503d805f81146200041a576040519150601f19603f3d011682016040523d82523d5f602084013e6200041f565b606091505b5091509150816200043257601562000448565b8080602001905181019062000448919062000e77565b60030b979650505050505050565b604051631da187d560e11b81526060906001600160a01b03831690633b430faa906200048790869060040162000c41565b5f604051808303815f875af1158015620004a3573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052620004cc919081019062000e99565b9392505050565b5f60605f806101676001600160a01b031663618dc65e60e01b87876040516024016200050192919062000f14565b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b031990941693909317909252905162000541919062000e5a565b5f604051808303815f865af19150503d805f81146200057c576040519150601f19603f3d011682016040523d82523d5f602084013e62000581565b606091505b50915091507f4af4780e06fe8cb9df64b0794fa6f01399af979175bb988e35e0e57e594567bc8282604051620005b992919062000f39565b60405180910390a181620005de57601560405180602001604052805f815250620005e2565b6016815b60039190910b97909650945050505050565b6060816001600160a01b03166306fdde036040518163ffffffff1660e01b81526004015f60405180830381865afa15801562000632573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526200065b919081019062000e99565b92915050565b604080516001600160a01b03831660248201523360448083019190915282518083039091018152606490910182526020810180516001600160e01b03166316e3e16160e21b17905290515f91829161016791620006be9162000e5a565b5f604051808303815f865af19150503d805f8114620006f9576040519150601f19603f3d011682016040523d82523d5f602084013e620006fe565b606091505b5091509150816200074c5760405162461bcd60e51b8152602060048201526013602482015272119c99595e99481d1bdad95b8819985a5b1959606a1b60448201526064015b60405180910390fd5b505050565b6040516001600160a01b038216903480156108fc02915f818181858888f1935050505015801562000784573d5f803e3d5ffd5b5050565b6060816001600160a01b03166395d89b416040518163ffffffff1660e01b81526004015f60405180830381865afa15801562000632573d5f803e3d5ffd5b60606001620007d6838262000fde565b5060018054620007e69062000f55565b80601f0160208091040260200160405190810160405280929190818152602001828054620008149062000f55565b8015620008635780601f10620008395761010080835404028352916020019162000863565b820191905f5260205f20905b8154815290600101906020018083116200084557829003601f168201915b50505050509050919050565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290525f908190819061016790639b23d3d960e01b9060a4016200039f565b60405162461bcd60e51b8152602060048201526015602482015274437573746f6d20726576657274206d65737361676560581b604482015260640162000743565b60018054620009049062000f55565b80601f0160208091040260200160405190810160405280929190818152602001828054620009329062000f55565b8015620009815780601f10620009575761010080835404028352916020019162000981565b820191905f5260205f20905b8154815290600101906020018083116200096357829003601f168201915b505050505081565b60605f6040516200099a9062000b75565b604051809103905ff080158015620009b4573d5f803e3d5ffd5b5090505f816001600160a01b0316633b430faa856040518263ffffffff1660e01b8152600401620009e6919062000c41565b5f604051808303815f875af115801562000a02573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f1916820160405262000a2b919081019062000e99565b604051630493789b60e31b81529091506001600160a01b0383169063249bc4d89062000a5c90849060040162000c41565b5f604051808303815f875af115801562000a78573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f1916820160405262000aa1919081019062000e99565b506001805462000ab19062000f55565b80601f016020809104026020016040519081016040528092919081815260200182805462000adf9062000f55565b801562000b2e5780601f1062000b045761010080835404028352916020019162000b2e565b820191905f5260205f20905b81548152906001019060200180831162000b1057829003601f168201915b505050505092505050919050565b5f805f545f1b60405162000b509062000b75565b8190604051809103905ff590508015801562000b6e573d5f803e3d5ffd5b5092915050565b61077e80620010ac83390190565b6001600160a01b038116811462000b98575f80fd5b50565b5f805f806080858703121562000baf575f80fd5b843562000bbc8162000b83565b9350602085013562000bce8162000b83565b9250604085013562000be08162000b83565b9396929550929360600135925050565b5f5b8381101562000c0c57818101518382015260200162000bf2565b50505f910152565b5f815180845262000c2d81602086016020860162000bf0565b601f01601f19169290920160200192915050565b602081525f620004cc602083018462000c14565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171562000c955762000c9562000c55565b604052919050565b5f67ffffffffffffffff82111562000cb95762000cb962000c55565b50601f01601f191660200190565b5f62000cdd62000cd78462000c9d565b62000c69565b905082815283838301111562000cf1575f80fd5b828260208301375f602084830101529392505050565b5f82601f83011262000d17575f80fd5b620004cc8383356020850162000cc7565b5f806040838503121562000d3a575f80fd5b823567ffffffffffffffff81111562000d51575f80fd5b62000d5f8582860162000d07565b925050602083013562000d728162000b83565b809150509250929050565b5f806040838503121562000d8f575f80fd5b823562000d9c8162000b83565b9150602083013567ffffffffffffffff81111562000db8575f80fd5b8301601f8101851362000dc9575f80fd5b62000dda8582356020840162000cc7565b9150509250929050565b828152604060208201525f62000dfe604083018462000c14565b949350505050565b5f6020828403121562000e17575f80fd5b8135620004cc8162000b83565b5f6020828403121562000e35575f80fd5b813567ffffffffffffffff81111562000e4c575f80fd5b62000dfe8482850162000d07565b5f825162000e6d81846020870162000bf0565b9190910192915050565b5f6020828403121562000e88575f80fd5b81518060030b8114620004cc575f80fd5b5f6020828403121562000eaa575f80fd5b815167ffffffffffffffff81111562000ec1575f80fd5b8201601f8101841362000ed2575f80fd5b805162000ee362000cd78262000c9d565b81815285602083850101111562000ef8575f80fd5b62000f0b82602083016020860162000bf0565b95945050505050565b6001600160a01b03831681526040602082018190525f9062000dfe9083018462000c14565b8215158152604060208201525f62000dfe604083018462000c14565b600181811c9082168062000f6a57607f821691505b60208210810362000f8957634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200074c57805f5260205f20601f840160051c8101602085101562000fb65750805b601f840160051c820191505b8181101562000fd7575f815560010162000fc2565b5050505050565b815167ffffffffffffffff81111562000ffb5762000ffb62000c55565b62001013816200100c845462000f55565b8462000f8f565b602080601f83116001811462001049575f8415620010315750858301515b5f19600386901b1c1916600185901b178555620010a3565b5f85815260208120601f198616915b82811015620010795788860151825594840194600190910190840162001058565b50858210156200109757878501515f19600388901b60f8161c191681555b505060018460011b0185555b50505050505056fe60a06040525f608081815261001490826100be565b50348015610020575f80fd5b5061017d565b634e487b7160e01b5f52604160045260245ffd5b600181811c9082168061004e57607f821691505b60208210810361006c57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156100b957805f5260205f20601f840160051c810160208510156100975750805b601f840160051c820191505b818110156100b6575f81556001016100a3565b50505b505050565b81516001600160401b038111156100d7576100d7610026565b6100eb816100e5845461003a565b84610072565b602080601f83116001811461011e575f84156101075750858301515b5f19600386901b1c1916600185901b178555610175565b5f85815260208120601f198616915b8281101561014c5788860151825594840194600190910190840161012d565b508582101561016957878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b6105f48061018a5f395ff3fe608060405234801561000f575f80fd5b506004361061003f575f3560e01c8063249bc4d8146100435780633b430faa1461006c578063c19d93fb1461007f575b5f80fd5b6100566100513660046102b0565b610087565b604051610063919061034c565b60405180910390f35b61005661007a3660046102b0565b61011c565b6100566101b9565b60405160609033908190639ac27b62906100a79086905f906020016103b6565b6040516020818303038152906040526040518263ffffffff1660e01b81526004016100d2919061034c565b5f604051808303815f875af11580156100ed573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526101149190810190610440565b509192915050565b60605f61012983826104fe565b505f80546101369061037e565b80601f01602080910402602001604051908101604052809291908181526020018280546101629061037e565b80156101ad5780601f10610184576101008083540402835291602001916101ad565b820191905f5260205f20905b81548152906001019060200180831161019057829003601f168201915b50505050509050919050565b5f80546101c59061037e565b80601f01602080910402602001604051908101604052809291908181526020018280546101f19061037e565b801561023c5780601f106102135761010080835404028352916020019161023c565b820191905f5260205f20905b81548152906001019060200180831161021f57829003601f168201915b505050505081565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561028157610281610244565b604052919050565b5f67ffffffffffffffff8211156102a2576102a2610244565b50601f01601f191660200190565b5f602082840312156102c0575f80fd5b813567ffffffffffffffff8111156102d6575f80fd5b8201601f810184136102e6575f80fd5b80356102f96102f482610289565b610258565b81815285602083850101111561030d575f80fd5b816020840160208301375f91810160200191909152949350505050565b5f5b8381101561034457818101518382015260200161032c565b50505f910152565b602081525f825180602084015261036a81604085016020870161032a565b601f01601f19169190910160400192915050565b600181811c9082168061039257607f821691505b6020821081036103b057634e487b7160e01b5f52602260045260245ffd5b50919050565b5f835160206103c982856020890161032a565b81840191505f85546103da8161037e565b600182811680156103f2576001811461040757610431565b60ff1984168752821515830287019450610431565b895f5260205f205f5b8481101561042957815489820152908301908701610410565b505082870194505b50929998505050505050505050565b5f60208284031215610450575f80fd5b815167ffffffffffffffff811115610466575f80fd5b8201601f81018413610476575f80fd5b80516104846102f482610289565b818152856020838501011115610498575f80fd5b6104a982602083016020860161032a565b95945050505050565b601f8211156104f957805f5260205f20601f840160051c810160208510156104d75750805b601f840160051c820191505b818110156104f6575f81556001016104e3565b50505b505050565b815167ffffffffffffffff81111561051857610518610244565b61052c81610526845461037e565b846104b2565b602080601f83116001811461055f575f84156105485750858301515b5f19600386901b1c1916600185901b1785556105b6565b5f85815260208120601f198616915b8281101561058d5788860151825594840194600190910190840161056e565b50858210156105aa57878501515f19600388901b60f8161c191681555b505060018460011b0185555b50505050505056fea2646970667358221220f9d4ec29ea6039c4ca833a4f380cc942538bdf4f493376c24d4853357941676664736f6c63430008180033a2646970667358221220992b617f20432b99cb9340eed5a817a1ba6bd3d2256265ae4753da69bc2f6da464736f6c63430008180033";

    private static final String INIT_BYTECODE_V3 =
            "608060405234801561001057600080fd5b50610201806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806316131e0f1461004657806342bcad281461006457806381ea440814610082575b600080fd5b61004e6100b2565b60405161005b919061014e565b60405180910390f35b61006c6100ba565b6040516100799190610133565b60405180910390f35b61009c600480360381019061009791906100e8565b6100c3565b6040516100a99190610133565b60405180910390f35b600044905090565b60004340905090565b600080823f905080915050919050565b6000813590506100e2816101b4565b92915050565b6000602082840312156100fe576100fd6101af565b5b600061010c848285016100d3565b91505092915050565b61011e8161017b565b82525050565b61012d816101a5565b82525050565b60006020820190506101486000830184610115565b92915050565b60006020820190506101636000830184610124565b92915050565b600061017482610185565b9050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600080fd5b6101bd81610169565b81146101c857600080fd5b5056fea2646970667358221220e0a2fbebf51001c00396785e8b125a7372b4ad7c429f2358b5acda5fb244ed5c64736f6c63430008070033";
    private static final String EXPECTED_RUNTIME_BYTECODE_V3 =
            "0x608060405234801561001057600080fd5b50600436106100415760003560e01c806316131e0f1461004657806342bcad281461006457806381ea440814610082575b600080fd5b61004e6100b2565b60405161005b919061014e565b60405180910390f35b61006c6100ba565b6040516100799190610133565b60405180910390f35b61009c600480360381019061009791906100e8565b6100c3565b6040516100a99190610133565b60405180910390f35b600044905090565b60004340905090565b600080823f905080915050919050565b6000813590506100e2816101b4565b92915050565b6000602082840312156100fe576100fd6101af565b5b600061010c848285016100d3565b91505092915050565b61011e8161017b565b82525050565b61012d816101a5565b82525050565b60006020820190506101486000830184610115565b92915050565b60006020820190506101636000830184610124565b92915050565b600061017482610185565b9050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600080fd5b6101bd81610169565b81146101c857600080fd5b5056fea2646970667358221220e0a2fbebf51001c00396785e8b125a7372b4ad7c429f2358b5acda5fb244ed5c64736f6c63430008070033";

    @Test
    void testExtractRuntimeBytecode() {
        assertThat(RuntimeBytecodeExtractor.extractRuntimeBytecode(INIT_BYTECODE_V1))
                .isEqualTo(EXPECTED_RUNTIME_BYTECODE_V1);
    }

    @Test
    void testExtractRuntimeBytecode2() {
        assertThat(RuntimeBytecodeExtractor.extractRuntimeBytecode(INIT_BYTECODE_V2))
                .isEqualTo(EXPECTED_RUNTIME_BYTECODE_V2);
    }

    @Test
    void testExtractRuntimeBytecode3() {
        assertThat(RuntimeBytecodeExtractor.extractRuntimeBytecode(INIT_BYTECODE_V3))
                .isEqualTo(EXPECTED_RUNTIME_BYTECODE_V3);
    }

    @Test
    void testExtractRuntimeBytecodeMissingCODECOPY() {
        String initBytecode = "6080abcdef"; // No CODECOPY present
        final var exception = assertThrows(RuntimeException.class, () -> {
            RuntimeBytecodeExtractor.extractRuntimeBytecode(initBytecode);
        });
        assertThat(exception.getMessage()).isEqualTo("CODECOPY instruction (39) not found in init bytecode.");
    }

    @Test
    void testExtractRuntimeBytecodeMissingRuntimePrefix() {
        String initBytecode = "395ff3fe"; // CODECOPY present but no runtime code prefix
        RuntimeException thrown = assertThrows(RuntimeException.class, () -> {
            RuntimeBytecodeExtractor.extractRuntimeBytecode(initBytecode);
        });
        assertThat(thrown.getMessage()).isEqualTo("Runtime code prefix (6080) not found after CODECOPY.");
    }
}
