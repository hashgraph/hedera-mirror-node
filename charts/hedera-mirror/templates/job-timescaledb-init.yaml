{{- if .Values.timescaledb.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    {{- include "hedera-mirror.labels" . | nindent 4 }}
  name: {{ include "hedera-mirror.dbHost" . }}-init-job
  namespace: {{ include "hedera-mirror.namespace" . }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  backoffLimit: 4
  template:
    spec:
      containers:
        - name: init-mirrornode-db
          image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3
          command:
            - sh
            - -c
            - |
              set -e

              while ! pg_isready -U postgres -h {{ include "hedera-mirror.dbHost" . }}-data; do sleep 1; done;
              psql --echo-queries -d "${ACCESS_SVC_CONNSTR_POSTGRES}" --set ON_ERROR_STOP=1 -f ${DB_INIT_FILE}
          env:
            - name: ACCESS_SVC_CONNSTR_POSTGRES
              value: host={{ include "hedera-mirror.dbHost" . }} user=postgres connect_timeout=3 sslmode=disable password={{ .Values.timescaledb.credentials.accessNode.superuser }}
            - name: DB_INIT_FILE
              value: /usr/etc/db-init/init_v2.sql
          volumeMounts:
            - name: timescale-db-init-volume
              mountPath: /usr/etc/db-init
      volumes:
        - name: timescale-db-init-volume
          secret:
            defaultMode: 420
            secretName: {{ include "hedera-mirror.dbHost" . }}-init
      restartPolicy: OnFailure
  ttlSecondsAfterFinished: 600
  {{- end -}}
