name: "V2 Schema"

on:
  pull_request:
    branches: [ master, release/** ]

env:
  MAVEN_CLI_OPTS: --batch-mode --no-transfer-progress --show-version
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Djib.skip -Ddocker.skip
  MAVEN_SPRING_OPTS: -Dembedded.postgresql.docker-image=timescaledev/timescaledb-ha:pg12.5-ts2.0.0-p0 -Dgroups=!v1
    -Dspring.flyway.locations=filesystem:../hedera-mirror-importer/src/main/resources/db/migration/v2
    -Dspring.flyway.baseline-version=1.999.999

jobs:
  grpc-tests:
    name: GRPC Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          key: ${{ runner.os }}-m2-${{ secrets.CACHE_VERSION }}-${{ hashFiles('hedera-mirror-grpc/pom.xml') }}
          path: ~/.m2
          restore-keys: ${{ runner.os }}-m2

      - name: Maven Verify
        run: ./mvnw ${MAVEN_CLI_OPTS} ${MAVEN_SPRING_OPTS} verify -pl hedera-mirror-protobuf,hedera-mirror-grpc

      - name: Upload grpc test results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: grpc-test-results
          path: hedera-mirror-grpc/target/surefire-reports/*
          retention-days: 7

  importer-tests:
    name: Importer Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          key: ${{ runner.os }}-m2-${{ secrets.CACHE_VERSION }}-${{ hashFiles('hedera-mirror-importer/pom.xml') }}
          path: ~/.m2
          restore-keys: ${{ runner.os }}-m2

      - name: Maven Verify
        run: ./mvnw ${MAVEN_CLI_OPTS} ${MAVEN_SPRING_OPTS} verify -pl hedera-mirror-importer/

      - name: Upload importer test results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: importer-test-results
          path: hedera-mirror-importer/target/surefire-reports/*
          retention-days: 7

  rest-tests:
    name: REST Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      working-directory: ./hedera-mirror-rest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Cache Node packages
        uses: actions/cache@v1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Maven verify
        run: ./mvnw ${MAVEN_CLI_OPTS} verify -pl hedera-mirror-rest/
        env:
          MIRROR_NODE_INT_DB: v2

      - name: Upload rest test results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: rest-test-results
          path: ${{env.working-directory}}/target/jest-junit/*
          retention-days: 7
